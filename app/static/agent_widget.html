<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Intelligence Widget</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js for Speedometer -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .pulse-dot {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .score-hot {
            color: #ef4444;
        }

        .score-warm {
            color: #f59e0b;
        }

        .score-cold {
            color: #3b82f6;
        }

        .battle-card {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-weight: 600;
        }

        .lead-item {
            transition: all 0.2s;
            cursor: pointer;
        }

        .lead-item:hover {
            background-color: #f3f4f6;
            transform: translateX(4px);
        }

        .action-btn {
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
    </style>
</head>

<body class="p-4">
    <!-- Authentication Overlay -->
    <div id="authOverlay"
        class="fixed inset-0 bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center z-50">
        <div class="card p-8 max-w-md w-full mx-4">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Sales Intelligence</h1>
                <p class="text-gray-600">Agent Dashboard</p>
            </div>

            <div id="authError"
                class="hidden mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-sm">
                Invalid password. Please try again.
            </div>

            <form id="authForm" onsubmit="handleAuth(event)" class="space-y-4">
                <div>
                    <label for="authPassword" class="block text-sm font-semibold text-gray-700 mb-2">
                        Access Password
                    </label>
                    <input type="password" id="authPassword"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                        placeholder="Enter password" required autofocus />
                </div>

                <button type="submit"
                    class="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:from-purple-700 hover:to-blue-700 transition-all duration-200 transform hover:scale-105">
                    Access Dashboard
                </button>
            </form>

            <div class="mt-6 text-center text-sm text-gray-500">
                <p>Authorized personnel only</p>
            </div>
        </div>
    </div>

    <!-- Dashboard View (List of Leads) -->
    <div id="dashboardView" style="display: none;">
        <div class="card p-6 mb-4">
            <h1 class="text-2xl font-bold text-gray-800 mb-4">Sales Intelligence Dashboard</h1>
            <p class="text-sm text-gray-600 mb-4">Top qualified leads from your conversations</p>
            <div id="topLeadsList" class="space-y-3">
                <div class="text-gray-500 text-center">Loading leads...</div>
            </div>
        </div>
    </div>

    <!-- Detail View (Individual Lead) -->
    <div id="detailView" style="display: none;">
        <button onclick="showDashboard()" class="mb-2 text-white text-sm font-semibold hover:underline">
            ← Back to Dashboard
        </button>

        <!-- Lead Score Gauge -->
        <div class="card p-6 mb-4">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Lead Score</h2>
            <div class="relative" style="height: 200px;">
                <canvas id="scoreGauge"></canvas>
            </div>
            <div class="mt-4 text-center">
                <div id="scoreValue" class="text-4xl font-bold">--</div>
                <div id="scoreCategory" class="text-sm text-gray-600 mt-1">Loading...</div>
            </div>
        </div>

        <!-- AI Analysis -->
        <div class="card p-4 mb-4" id="intelligenceCard">
            <h2 class="text-lg font-semibold text-gray-800 mb-3">AI Analysis</h2>

            <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                    <span class="text-gray-600">Intent:</span>
                    <span id="intent" class="font-semibold">--</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Sentiment:</span>
                    <span id="sentiment" class="font-semibold">--</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Budget Signal:</span>
                    <span id="budgetSignal" class="font-semibold">--</span>
                </div>
            </div>

            <!-- Pain Points -->
            <div class="mt-4">
                <h3 class="text-sm font-semibold text-gray-700 mb-2">Pain Points:</h3>
                <ul id="painPoints" class="text-sm text-gray-600 space-y-1"></ul>
            </div>

            <!-- Battle Card -->
            <div id="battleCardContainer" style="display: none;">
                <div class="battle-card">
                    <div class="text-xs uppercase mb-1">⚔️ Competitive Intel</div>
                    <div id="battleCardText" class="text-sm"></div>
                </div>
            </div>
        </div>

        <!-- CRM Integration -->
        <div class="card p-4 mb-4" id="crmCard">
            <h2 class="text-lg font-semibold text-gray-800 mb-3">CRM Integration</h2>

            <div class="space-y-2 text-sm">
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">Sync Status:</span>
                    <span id="crmStatus" class="font-semibold">--</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">CRM Lead ID:</span>
                    <span id="crmLeadId" class="font-mono text-xs">--</span>
                </div>
                <div id="crmErrorContainer" style="display: none;"
                    class="mt-2 p-2 bg-red-50 border border-red-200 rounded">
                    <div class="text-xs text-red-700 font-semibold mb-1">Sync Error:</div>
                    <div id="crmError" class="text-xs text-red-600"></div>
                </div>
                <div id="crmLinkContainer" style="display: none;" class="mt-2">
                    <a id="crmLink" href="#" target="_blank"
                        class="inline-block w-full text-center bg-gradient-to-r from-blue-600 to-purple-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:from-blue-700 hover:to-purple-700 transition">
                        Open in Zoho CRM →
                    </a>
                </div>
            </div>
        </div>

        <!-- Recommended Actions -->
        <div class="card p-4 mb-4" id="actionCard">
            <h2 class="text-sm font-semibold text-gray-700 mb-2">Recommended Action</h2>
            <div id="primaryAction"></div>
        </div>

        <!-- Executive Summary -->
        <div class="card p-4" id="summaryCard">
            <h2 class="text-sm font-semibold text-gray-700 mb-2">Executive Summary</h2>
            <p id="summaryText" class="text-sm text-gray-600"></p>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const BACKEND_URL = 'https://e4917fa4cac4.ngrok-free.app';
        const ZOHO_SECRET = 'shyam@zoho2005';
        const WIDGET_PASSWORD = 'sales2025';
        const ZOHO_CRM_BASE_URL = 'https://crm.zoho.in/crm/org60059138222/tab/Leads';

        let CURRENT_VISITOR_ID = null;
        let scoreChart = null;
        let pollTimer = null;
        let isAuthenticated = false;

        // ==================== AUTHENTICATION ====================

        function handleAuth(event) {
            event.preventDefault();
            const password = document.getElementById('authPassword').value;

            if (password === WIDGET_PASSWORD) {
                isAuthenticated = true;
                document.getElementById('authOverlay').style.display = 'none';
                document.getElementById('authError').classList.add('hidden');
                init();
            } else {
                document.getElementById('authError').classList.remove('hidden');
                document.getElementById('authPassword').value = '';
            }
        }

        // ==================== INITIALIZATION ====================

        function init() {
            if (!isAuthenticated) return;

            const urlParams = new URLSearchParams(window.location.search);
            const urlVisitorId = urlParams.get('visitor_id');

            if (urlVisitorId) {
                loadVisitorDetail(urlVisitorId);
            } else {
                showDashboard();
            }
        }

        // ==================== VIEW MANAGEMENT ====================

        function showDashboard() {
            document.getElementById('dashboardView').style.display = 'block';
            document.getElementById('detailView').style.display = 'none';
            stopPolling();
            fetchTopLeads();
        }

        function loadVisitorDetail(visitorId) {
            CURRENT_VISITOR_ID = visitorId;
            document.getElementById('dashboardView').style.display = 'none';
            document.getElementById('detailView').style.display = 'block';

            if (!scoreChart) initScoreGauge();
            refreshDetailData();
            startPolling();
        }

        // ==================== DASHBOARD LOGIC ====================

        async function fetchTopLeads() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/v1/leads/top?limit=50`, {
                    headers: { 'x-salesiq-auth': ZOHO_SECRET }
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const leads = await response.json();
                renderTopLeads(leads);
            } catch (error) {
                console.error('Failed to fetch top leads:', error);
                document.getElementById('topLeadsList').innerHTML =
                    '<div class="text-red-500 text-center">Failed to load leads</div>';
            }
        }

        function renderTopLeads(leads) {
            const container = document.getElementById('topLeadsList');
            container.innerHTML = '';

            if (leads.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-center">No qualified leads yet.</div>';
                return;
            }

            leads.forEach(lead => {
                const div = document.createElement('div');
                div.className = 'lead-item p-3 border border-gray-100 rounded-lg flex justify-between items-center';
                div.onclick = () => loadVisitorDetail(lead.visitor_id);

                let badgeColor = 'bg-blue-100 text-blue-800';
                if (lead.category === 'Hot') badgeColor = 'bg-red-100 text-red-800';
                if (lead.category === 'Warm') badgeColor = 'bg-orange-100 text-orange-800';

                div.innerHTML = `
                    <div>
                        <div class="font-bold text-gray-800">${lead.visitor_id}</div>
                        <div class="text-xs text-gray-500">${lead.intent} • ${lead.priority} Priority</div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-bold ${lead.category === 'Hot' ? 'text-red-500' : 'text-blue-500'}">
                            ${lead.score}
                        </div>
                        <span class="text-xs px-2 py-1 rounded-full ${badgeColor} font-semibold">
                            ${lead.category}
                        </span>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // ==================== DETAIL VIEW LOGIC ====================

        function initScoreGauge() {
            const ctx = document.getElementById('scoreGauge').getContext('2d');
            scoreChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: ['rgb(59, 130, 246)', 'rgb(229, 231, 235)'],
                        borderWidth: 0,
                        circumference: 180,
                        rotation: 270
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%',
                    plugins: { legend: { display: false }, tooltip: { enabled: false } }
                }
            });
        }

        async function refreshDetailData() {
            if (!CURRENT_VISITOR_ID) return;
            try {
                const response = await fetch(`${BACKEND_URL}/api/v1/leads/${CURRENT_VISITOR_ID}`, {
                    headers: { 'x-salesiq-auth': ZOHO_SECRET }
                });
                if (!response.ok) throw new Error('Lead not found');
                const data = await response.json();
                updateDetailUI(data);
            } catch (error) {
                console.error(error);
            }
        }

        function updateDetailUI(data) {
            let color = data.score >= 80 ? 'rgb(239, 68, 68)' : (data.score >= 50 ? 'rgb(245, 158, 11)' : 'rgb(59, 130, 246)');
            scoreChart.data.datasets[0].data = [data.score, 100 - data.score];
            scoreChart.data.datasets[0].backgroundColor = [color, 'rgb(229, 231, 235)'];
            scoreChart.update();

            document.getElementById('scoreValue').textContent = data.score;
            document.getElementById('scoreValue').className = `text-4xl font-bold score-${data.category.toLowerCase()}`;
            document.getElementById('scoreCategory').textContent = `${data.category} Lead - ${data.priority} Priority`;

            document.getElementById('intent').textContent = data.intent;
            document.getElementById('sentiment').textContent = data.sentiment;
            document.getElementById('budgetSignal').textContent = data.budget_signal;

            const ppList = document.getElementById('painPoints');
            ppList.innerHTML = data.pain_points.map(p => `<li>• ${p}</li>`).join('') || '<li class="text-gray-400">None</li>';

            const bc = document.getElementById('battleCardContainer');
            if (data.battle_card) {
                document.getElementById('battleCardText').textContent = data.battle_card;
                bc.style.display = 'block';
            } else {
                bc.style.display = 'none';
            }

            // Update CRM Status
            updateCRMStatus(data);

            document.getElementById('primaryAction').innerHTML = `
                <button onclick="executeAction('${data.action}')" 
                        class="action-btn w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-3 rounded-lg font-bold text-center">
                    ${data.action}
                </button>`;

            document.getElementById('summaryText').textContent = data.summary;
        }

        function updateCRMStatus(data) {
            const crmStatus = document.getElementById('crmStatus');
            const crmLeadId = document.getElementById('crmLeadId');
            const crmErrorContainer = document.getElementById('crmErrorContainer');
            const crmError = document.getElementById('crmError');
            const crmLinkContainer = document.getElementById('crmLinkContainer');
            const crmLink = document.getElementById('crmLink');

            // Check if CRM data exists
            if (data.crm_synced) {
                crmStatus.innerHTML = '<span class="text-green-600">✓ Synced</span>';
                crmLeadId.textContent = data.crm_lead_id || '--';
                crmErrorContainer.style.display = 'none';

                if (data.crm_lead_id) {
                    crmLink.href = `${ZOHO_CRM_BASE_URL}/${data.crm_lead_id}`;
                    crmLinkContainer.style.display = 'block';
                }
            } else if (data.crm_sync_error) {
                crmStatus.innerHTML = '<span class="text-red-600">✗ Sync Failed</span>';
                crmLeadId.textContent = '--';
                crmError.textContent = data.crm_sync_error;
                crmErrorContainer.style.display = 'block';
                crmLinkContainer.style.display = 'none';
            } else {
                crmStatus.innerHTML = '<span class="text-yellow-600">⏳ Pending</span>';
                crmLeadId.textContent = '--';
                crmErrorContainer.style.display = 'none';
                crmLinkContainer.style.display = 'none';
            }
        }

        // ==================== UTILS ====================

        function startPolling() {
            if (pollTimer) clearInterval(pollTimer);
            pollTimer = setInterval(refreshDetailData, 5000);
        }

        function stopPolling() {
            if (pollTimer) clearInterval(pollTimer);
        }

        function executeAction(action) { alert(`Executing: ${action}`); }

    </script>
</body>

</html>